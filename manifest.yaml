type: install
id: ghost-docker
version: '2.0'
appVersion: latest
name: Ghost
baseUrl: https://raw.githubusercontent.com/TaylorJadin/Ghost-docker-jps/master/
logo: /ghost-logo.png
homepage: https://ghost.org/

categories: 
- apps/content-management

description: 
  text: Ghost is a free, open-source blogging platform with a user-friendly interface designed to simplify and speed up online publishing process.
  short: The professional publishing platform

globals:
  ghostdbPass: ${fn.password}
  shortname: ghost
  path: /root/ghost
  repo: https://github.com/TryGhost/ghost-docker.git
  
nodes:
  nodeType: dockerengine
  nodeGroup: cp
  cloudlets: 16
  fixedcloudlets: 3
  extip: true
  displayName: Ghost server
  addons: [change-domain, mail-setup, update-ghost]
  volumes: ["/root/ghost"]

settings:
  domain:
    fields:
      - name: displayfield
        type: displayfield
        hideLabel: true
        markup: |
          The new domain should already have an A record pointed at this environment's IP address.
      - name: domain
        hideLabel: true
        caption: Domain
        type: string
        vtype: extdomain
  mail-settings:
    fields:
      - name: mailfrom
        caption: From Address
        type: string
        vtype: email
      - name: mailuser
        caption: Username
        type: string
      - name: mailpassword
        caption: Password
        type: string
        inputType: password
      - name: mailhost
        caption: Host
        type: string
        inputtype: string
      - name: mailport
        caption: Port
        type: string
        inputtype: string
      - name: mailservice
        caption: Service
        type: string
        inputtype: string
      - name: mailtransport
        caption: Transport
        type: string
        inputtype: string

onInstall:
  - setup

actions:
  setup:      
    - cmd[cp]: |-
        mkdir -p ${globals.path}
        cd ${globals.path}
        # Clear out old files if they exist to ensure clean slate for git clone
        rm -rf .git manifest.yaml ghost-logo.png .gitattributes
        
        # Clone official repo
        git clone ${globals.repo} .

        # Create symlink to /opt/ghost
        ln -s ${globals.path} /opt/ghost
        
        # Configure file structure
        cp .env.example .env
        cp caddy/Caddyfile.example caddy/Caddyfile
        
        # Configure .env
        sed -i \
        -e "s|DOMAIN=.*|DOMAIN=${env.domain}|g" \
        -e "s|DATABASE_ROOT_PASSWORD=.*|DATABASE_ROOT_PASSWORD=${fn.password}|g" \
        -e "s|DATABASE_PASSWORD=.*|DATABASE_PASSWORD=${globals.ghostdbPass}|g" \
        -e "s|mail__transport=.*|mail__transport=${settings.mailtransport}|g" \
        -e "s|mail__options__host=.*|mail__options__host=${settings.mailhost}|g" \
        -e "s|mail__options__port=.*|mail__options__port=${settings.mailport}|g" \
        -e "s|mail__options__auth__user=.*|mail__options__auth__user=${settings.mailuser}|g" \
        -e "s|mail__options__auth__pass=.*|mail__options__auth__pass=${settings.mailpassword}|g" \
        -e "s|mail__from=.*|mail__from=\"${settings.mailfrom}\"|g" \
        .env

        # Enable ActivityPub
        sed -i 's|# COMPOSE_PROFILES=analytics,activitypub|COMPOSE_PROFILES=activitypub|g' .env
        sed -i 's|# ACTIVITYPUB_TARGET=activitypub:8080|ACTIVITYPUB_TARGET=activitypub:8080|g' .env

        docker compose up -d
    - env.file.AddFavorite:
        nodeGroup: cp
        path: ${globals.path}
        keyword: ghost
        isDir: true

addons:
  - id: change-domain
    name: Domain Configuration
    description: Change the Domain name for Ghost and Caddy.
    permanent: true
    buttons:
      - confirmText: Are you sure you want to proceed?
        loadingText: Changing domain...
        action: changeDomain
        caption: Change
        successText: The domain has been updated successfully!
        settings: domain
        title: Please specify the new domain name

    actions:
      changeDomain:
        - cmd[cp]: |-
            cd ${globals.path}
            sed -i "s|DOMAIN=.*|DOMAIN=${settings.domain}|g" .env
            docker compose up -d --force-recreate

  - id: mail-setup
    name: Mail Setup
    description: Configure Ghost's mail settings
    permanent: true
    buttons:
      - confirmText: Are you sure you want to proceed?
        loadingText: Changing Ghost configuration...
        action: mailConfig
        caption: Configure
        successText: Your Ghost environment has been re-configured successfully!
        settings: mail-settings
        title: Please enter your mail details

    actions:
      mailConfig:
        - cmd[cp]: |-
            cd ${globals.path}
            sed -i \
            -e "s|mail__from=.*|mail__from=\"${settings.mailfrom}\"|" \
            -e "s|mail__options__host=.*|mail__options__host=${settings.mailhost}|" \
            -e "s|mail__options__auth__user=.*|mail__options__auth__user=${settings.mailuser}|" \
            -e "s|mail__options__auth__pass=.*|mail__options__auth__pass=${settings.mailpassword}|" \
            -e "s|mail__options__port=.*|mail__options__port=${settings.mailport}|" \
            -e "s|mail__options__service=.*|mail__options__service=${settings.mailservice}|" \
            -e "s|mail__transport=.*|mail__transport=${settings.mailtransport}|" \
            .env
            docker compose up -d --force-recreate
    
  - id: update-ghost
    name: Update Ghost
    description: Pull the latest version of the Ghost docker container
    permanent: true
    buttons:
      - confirmText: Are you sure you want to proceed?
        loadingText: Updating Ghost...
        action: updateGhost
        caption: Update
        successText: Your Ghost environment has been updated!
        title: Update Ghost
    actions:
      updateGhost:
        -  cmd[cp]: |-
            cd ${globals.path}
            docker compose pull
            docker compose down
            docker compose up -d --force-recreate

success: | 
  **Ghost**: [https://${env.domain}/](https://${env.domain}/)
  - Set up Ghost by visiting [${env.domain}/ghost](https://${env.domain}/ghost)
  - If you want to change the domain name, point an A record at **${nodes.cp.extIPs}** then use the **Domain Configuration** Add-On to change the domain name.
  - Further information on setting up Ghost can be found at [support.reclaimhosting.com/hc/en-us/articles/8024410882839](https://support.reclaimhosting.com/hc/en-us/articles/8024410882839)
